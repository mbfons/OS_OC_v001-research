has_disability = ifelse(is.na(has_disability),0,has_disability)
)
df_cleaned <- df_input %>%
mutate(age_group = factor(cut(age,breaks = c(0,18,40,50,60,70,80, Inf),dig.lab = 2)),
sex = factor(case_when(sex=="F" ~ "Female",sex=="M" ~ "Male",TRUE ~ sex)),
ethnicity = factor(case_when(ethnicity==1 ~ "White",ethnicity==2 ~ "Mixed",ethnicity==3 ~ "Asian",ethnicity==4 ~ "Black",ethnicity==5 ~ "Other")),
care_home_type=factor(care_home_type),
gp_consult_had = ifelse(is.na(gp_consult_count)|gp_consult_count==0,0,1),
oc_instance_had = ifelse(is.na(OC_instance)|OC_instance==0,0,1),
livingalone = ifelse(hh_size<=4,1,0),
has_disability = ifelse(is.na(has_disability),0,has_disability)
)
## OC and GP rates per age and gender
tb04_gpcr_agesex <- df_to_tbrates(df_cleaned,c("age_group","sex"),1,"tb04_gpcr_agesex")
tb04_gpcr_agesex %>% view()
gt_ocpop <- df_cleaned %>% select(desc_vars) %>% tbl_summary(by=oc_instance_had) %>% add_p() %>% add_overall() %>% modify_header(label="**Characteristic | had OC**") %>%
modify_spanning_header(c("stat_1", "stat_2") ~ "**Treatment Received**")
gt_ocpop <- df_cleaned %>% select(desc_vars) %>% tbl_summary(by=oc_instance_had) %>% add_p() %>% add_overall() %>% modify_header(label="**Characteristic | had OC**") %>%
modify_spanning_header(c("0", "1") ~ "**Treatment Received**")
gt_ocpop <- df_cleaned %>% select(desc_vars) %>% tbl_summary(by=oc_instance_had) %>% add_p() %>% add_overall() %>% modify_header(label="**Characteristic | had OC**") %>%
modify_spanning_header(c("stat_1", "stat_2") ~ "**Treatment Received**")
gt_ocpop <-
df_cleaned %>% select(desc_vars) %>% tbl_summary(by=oc_instance_had) %>% add_p() %>% add_overall() %>% modify_header(label="**Characteristic | had OC**") %>%
modify_spanning_header(c("stat_1", "stat_2") ~ "**Treatment Received**")
gt_ocpop <-
df_cleaned %>% select(desc_vars) %>% tbl_summary(by=oc_instance_had) %>% add_p() %>% add_overall() %>% modify_header(label="**Characteristic | had OC**") %>%
modify_spanning_header(c("stat_1", "stat_2") ~ "**Treatment Received**")
gt_ocpop <-
df_cleaned %>% select(desc_vars) %>% tbl_summary(by=oc_instance_had) %>% add_p() %>% add_overall() %>% modify_header(label="**Characteristic | had OC**")
gt_gpcpop <- df_cleaned %>% select(desc_vars2) %>% tbl_summary(by=gp_consult_had) %>% add_p() %>% add_overall() %>% modify_header(label="**Characteristic | had GP consultation**")
## Characteristics of those with any OC consultation, any GP consultation and overall population
desc_vars=c("sex","age","age_group","ethnicity","livingalone","region","rural_urban","care_home_type","oc_instance_had")
gt_ocpop <-
df_cleaned %>% select(desc_vars) %>% tbl_summary(by=oc_instance_had) %>% add_p() %>% add_overall() %>% modify_header(label="**Characteristic | had OC**")
df_cleaned %>% select(desc_vars) %>% tbl_summary(by=oc_instance_had) %>% add_p() %>% add_overall() %>% modify_header(label="**Characteristic | had OC**")
df_cleaned %>% select(desc_vars) %>% tbl_summary(by=oc_instance_had) %>% add_p() %>% add_overall() %>% modify_header(label="**Characteristic | had OC**") modify_spanning_header(c("stat_1", "stat_2") ~ "**Had any OC instance**")
df_cleaned %>% select(desc_vars) %>% tbl_summary(by=oc_instance_had) %>% add_p() %>% add_overall() %>% modify_header(label="**Characteristic | had OC**") %>% modify_spanning_header(c("stat_1", "stat_2") ~ "**Had any OC instance**")
df_cleaned %>% select(desc_vars) %>% tbl_summary(by=oc_instance_had) %>% add_p() %>% add_overall() %>% modify_header(label="**Characteristic | had OC**") %>% modify_spanning_header(c("stat_1", "stat_2") ~ "**Had any OC instance**")
gt_ocpop <- df_cleaned %>% select(desc_vars) %>% tbl_summary(by=oc_instance_had) %>% add_p() %>% add_overall() %>% modify_header(label="**Characteristic | had OC**") %>% modify_spanning_header(c("stat_1", "stat_2") ~ "**Had any OC instance**")
View(gt_ocpop)
as.gt(gt_ocpop)
as_gt(gt_ocpop)
as_gt(gt_ocpop)
?save
# Save dta with actual table data
save(gt_ocpop,file = file.path(here::here("output","tables"), "gt_ocpop.RData"))
(gt_ocpop <- df_cleaned %>% select(desc_vars) %>% tbl_summary(by=oc_instance_had) %>% add_p() %>% add_overall() %>% modify_header(label="**Characteristic | had OC**") %>% modify_spanning_header(c("stat_1", "stat_2") ~ "**Had any OC instance**"))
(gt_gpcpop <- df_cleaned %>% select(desc_vars2) %>% tbl_summary(by=gp_consult_had) %>% add_p() %>% add_overall() %>% modify_header(label="**Characteristic | had GP consultation**") %>% modify_spanning_header(c("stat_1", "stat_2") ~ "**Had any GP consultation**"))
(gt_gpcpop <- df_cleaned %>% select(desc_vars2) %>% tbl_summary(by=gp_consult_had) %>% add_p() %>% add_overall() %>% modify_header(label="**Characteristic | had GP consultation**") %>% modify_spanning_header(c("stat_1", "stat_2") ~ "**Had any GP consultation**"))
save(gt_gpcpop,file = file.path(here::here("output","tables"), "gt_gpcpop.RData"))
## open log connection to file
sink(here::here("logs", "log-01-createSDtables.txt"))
## library
library(tidyverse)
library(gtsummary)
library(gt)
library(here)
## import and pre-process cohort data
df_input <- read_csv(
here::here("output", "input_ori.csv"))
df_cleaned <- df_input %>%
mutate(age_group = factor(cut(age,breaks = c(0,18,40,50,60,70,80, Inf),dig.lab = 2)),
sex = factor(case_when(sex=="F" ~ "Female",sex=="M" ~ "Male",TRUE ~ sex)),
ethnicity = factor(case_when(ethnicity==1 ~ "White",ethnicity==2 ~ "Mixed",ethnicity==3 ~ "Asian",ethnicity==4 ~ "Black",ethnicity==5 ~ "Other")),
care_home_type=factor(care_home_type),
gp_consult_had = ifelse(is.na(gp_consult_count)|gp_consult_count==0,0,1),
oc_instance_had = ifelse(is.na(OC_instance)|OC_instance==0,0,1),
livingalone = ifelse(hh_size<=4,1,0),
has_disability = ifelse(is.na(has_disability),0,has_disability)
)
## Characteristics of those with any OC consultation, any GP consultation and overall population
desc_vars=c("sex","age","age_group","ethnicity","livingalone","region","rural_urban","care_home_type","oc_instance_had")
(gt_ocpop <- df_cleaned %>% select(desc_vars) %>% tbl_summary(by=oc_instance_had) %>% add_p() %>% add_overall() %>% modify_header(label="**Characteristic | had OC**") %>% modify_spanning_header(c("stat_1", "stat_2") ~ "**Had any OC instance**"))
desc_vars2=c("sex","age","age_group","ethnicity","livingalone","region","rural_urban","care_home_type","gp_consult_had")
df_cleaned <- df_input %>%
mutate(age_group = factor(cut(age,breaks = c(0,18,40,50,60,70,80, Inf),dig.lab = 2)),
sex = factor(case_when(sex=="F" ~ "Female",sex=="M" ~ "Male",TRUE ~ sex)),
ethnicity = factor(case_when(ethnicity==1 ~ "White",ethnicity==2 ~ "Mixed",ethnicity==3 ~ "Asian",ethnicity==4 ~ "Black",ethnicity==5 ~ "Other")),
care_home_type=factor(care_home_type),
gp_consult_had = ifelse(is.na(gp_consult_count)|gp_consult_count==0,0,1),
oc_instance_had = ifelse(is.na(OC_instance)|OC_instance==0,0,1),
livingalone = ifelse(hh_size<=1,1,0),
has_disability = ifelse(is.na(has_disability),0,has_disability)
)
## Characteristics of those with any OC consultation, any GP consultation and overall population
desc_vars=c("sex","age","age_group","ethnicity","livingalone","region","rural_urban","care_home_type","oc_instance_had")
(gt_ocpop <- df_cleaned %>% select(desc_vars) %>% tbl_summary(by=oc_instance_had) %>% add_p() %>% add_overall() %>% modify_header(label="**Characteristic | had OC**") %>% modify_spanning_header(c("stat_1", "stat_2") ~ "**Had any OC instance**"))
## Characteristics of those with any OC consultation, any GP consultation and overall population
desc_vars=c("sex","age","age_group","ethnicity","livingalone","region","rural_urban","care_home_type","oc_instance_had")
(gt_ocpop <- df_cleaned %>% select(desc_vars) %>% tbl_summary(by=oc_instance_had) %>% add_p() %>% add_overall() %>% modify_header(label="**Characteristic | had OC**") %>% modify_spanning_header(c("stat_1", "stat_2") ~ "**Had any OC instance**"))
desc_vars2=c("sex","age","age_group","ethnicity","livingalone","region","rural_urban","care_home_type","gp_consult_had")
(gt_gpcpop <- df_cleaned %>% select(desc_vars2) %>% tbl_summary(by=gp_consult_had) %>% add_p() %>% add_overall() %>% modify_header(label="**Characteristic | had GP consultation**") %>% modify_spanning_header(c("stat_1", "stat_2") ~ "**Had any GP consultation**"))
# Save dta with actual table data
save(gt_ocpop,file = file.path(here::here("output"), "gt_ocpop.RData"))
save(gt_gpcpop,file = file.path(here::here("output"), "gt_gpcpop.RData"))
df_to_tbrates <- function(mydf,myvars,flag_save=0,tb_name="latest") {
mytb=
mydf %>%
group_by_at(myvars) %>%
summarise(
population=n(),
gp_consult=sum(gp_consult_count,na.rm=T),
gp_consult_covg = sum(gp_consult_had,na.rm=T),
gp_consult_rate=gp_consult/population,
gp_consult_covg_rate=gp_consult_covg/population,
oc_instance=sum(OC_instance,na.rm=T),
oc_instance_covg=sum(oc_instance_had,na.rm=T),
oc_instance_rate=oc_instance/population,
oc_instance_covg_rate=oc_instance_covg/population
)
if (flag_save){
write.csv(mytb,paste0(here::here("output"),"/",tb_name,".csv"))
}
return(mytb)
}
## OC and GP rates per region
tb01_gpcr_region <- df_to_tbrates(df_cleaned,c("region"),1,"tb01_gpcr_region")
View(tb01_gpcr_region)
## OC and GP rates per STP
tb02_gpcr_stp <- df_to_tbrates(df_cleaned,c("stp"),1,"tb02_gpcr_stp")
## OC and GP rates per age and gender
tb04_gpcr_agesex <- df_to_tbrates(df_cleaned,c("age_group","sex"),1,"tb04_gpcr_agesex")
## OC and GP rates by ethnicity
tb05_gpcr_ethnicity <- df_to_tbrates(df_cleaned,c("ethnicity"),1,"tb05_gpcr_ethnicity")
## OC and GP rates by region and rurality
tb06_gpcr_ruc <- df_to_tbrates(df_cleaned,c("region","rural_urban"),1,"tb06_gpcr_ruc")
## OC and GP rates by care home status
tb07_gpcr_care <- df_to_tbrates(df_cleaned,c("care_home_type"),1,"tb07_gpcr_care")
## OC and GP rates by presence of disability
tb08_gpcr_dis <- df_to_tbrates(df_cleaned,c("has_disability"),1,"tb08_gpcr_dis")
## close log connection
sink()
## open log connection to file
sink(here::here("logs", "log-01-createSDtables.txt"))
## library
library(tidyverse)
library(gtsummary)
library(gt)
library(here)
## import and pre-process cohort data
df_input <- read_csv(
here::here("output", "input_ori.csv"))
df_cleaned <- df_input %>%
mutate(age_group = factor(cut(age,breaks = c(0,18,40,50,60,70,80, Inf),dig.lab = 2)),
sex = factor(case_when(sex=="F" ~ "Female",sex=="M" ~ "Male",TRUE ~ sex)),
ethnicity = factor(case_when(ethnicity==1 ~ "White",ethnicity==2 ~ "Mixed",ethnicity==3 ~ "Asian",ethnicity==4 ~ "Black",ethnicity==5 ~ "Other")),
care_home_type=factor(care_home_type),
gp_consult_had = ifelse(is.na(gp_consult_count)|gp_consult_count==0,0,1),
oc_instance_had = ifelse(is.na(OC_instance)|OC_instance==0,0,1),
livingalone = ifelse(hh_size<=1,1,0),
has_disability = ifelse(is.na(has_disability),0,has_disability)
)
## Characteristics of those with any OC consultation, any GP consultation and overall population
desc_vars=c("sex","age","age_group","ethnicity","livingalone","region","rural_urban","care_home_type","oc_instance_had")
(gt_ocpop <- df_cleaned %>% select(desc_vars) %>% tbl_summary(by=oc_instance_had) %>% add_p() %>% add_overall() %>% modify_header(label="**Characteristic | had OC**") %>% modify_spanning_header(c("stat_1", "stat_2") ~ "**Had any OC instance**"))
desc_vars2=c("sex","age","age_group","ethnicity","livingalone","region","rural_urban","care_home_type","gp_consult_had")
(gt_gpcpop <- df_cleaned %>% select(desc_vars2) %>% tbl_summary(by=gp_consult_had) %>% add_p() %>% add_overall() %>% modify_header(label="**Characteristic | had GP consultation**") %>% modify_spanning_header(c("stat_1", "stat_2") ~ "**Had any GP consultation**"))
# Save dta with actual table data
save(gt_ocpop,file = file.path(here::here("output"), "gt_ocpop.RData"))
save(gt_gpcpop,file = file.path(here::here("output"), "gt_gpcpop.RData"))
df_to_tbrates <- function(mydf,myvars,flag_save=0,tb_name="latest") {
mytb=
mydf %>%
group_by_at(myvars) %>%
summarise(
population=n(),
gp_consult=sum(gp_consult_count,na.rm=T),
gp_consult_covg = sum(gp_consult_had,na.rm=T),
gp_consult_rate=gp_consult/population,
gp_consult_covg_rate=gp_consult_covg/population,
oc_instance=sum(OC_instance,na.rm=T),
oc_instance_covg=sum(oc_instance_had,na.rm=T),
oc_instance_rate=oc_instance/population,
oc_instance_covg_rate=oc_instance_covg/population
)
if (flag_save){
write.csv(mytb,paste0(here::here("output"),"/",tb_name,".csv"))
}
return(mytb)
}
## OC and GP rates per region
tb01_gpcr_region <- df_to_tbrates(df_cleaned,c("region"),1,"tb01_gpcr_region")
View(tb01_gpcr_region)
## OC and GP rates per STP
tb02_gpcr_stp <- df_to_tbrates(df_cleaned,c("stp"),1,"tb02_gpcr_stp")
## OC and GP rates per age and gender
tb04_gpcr_agesex <- df_to_tbrates(df_cleaned,c("age_group","sex"),1,"tb04_gpcr_agesex")
## OC and GP rates by ethnicity
tb05_gpcr_ethnicity <- df_to_tbrates(df_cleaned,c("ethnicity"),1,"tb05_gpcr_ethnicity")
## OC and GP rates by region and rurality
tb06_gpcr_ruc <- df_to_tbrates(df_cleaned,c("region","rural_urban"),1,"tb06_gpcr_ruc")
## OC and GP rates by care home status
tb07_gpcr_care <- df_to_tbrates(df_cleaned,c("care_home_type"),1,"tb07_gpcr_care")
## OC and GP rates by presence of disability
tb08_gpcr_dis <- df_to_tbrates(df_cleaned,c("has_disability"),1,"tb08_gpcr_dis")
## close log connection
sink()
# create look-up table to iterate over
md_tbl <- tibble(
measure = c("gpc", "gpc", "ocir", "ocir"),
measure_label = c("GPconsult", "GPconsult", "OCinstance", "OCinstance"),
by = c("practice", "stp", "practice", "stp"),
by_label = c("by practice", "by STP", "by practice", "by STP"),
id = paste0(measure, "_", by),
numerator = measure,
denominator = "population",
group_by = c("practice", "stp", "practice", "stp"),
)
## import measures data from look-up
measures <- md_tbl %>%
mutate(
data = map(id, ~read_csv(here::here("output", glue::glue("measure_{.}.csv")))),
)
measures_ocir_pratice <- measures$data[[match("ocir_practice",measures$id)]]
measures_ocir_stp <- measures$data[[match("ocir_stp",measures$id)]]
measures_gpc_pratice <- measures$data[[match("gpc_practice",measures$id)]]
measures_gpc_stp <- measures$data[[match("gpc_stp",measures$id)]]
measures_ocir_pop <-
measures_ocir_pratice %>%
group_by(date) %>%
summarise(population=sum(population),OC_instance=sum(OC_instance),value=OC_instance/population)
View(measures_ocir_pop )
measures_gpc_pop <-
measures_gpc_pratice %>%
group_by(date) %>%
summarise(population=sum(population),gp_consult_count=sum(gp_consult_count),value=gp_consult_count/population)
write.csv(measures_gpc_pop,paste0(here::here("output","tables"),"/measures_gpc_pop.csv"))
measures_ocir_pop %>% mutate(value_10000 = value*10000) %>%
ggplot()+
geom_line(aes_string(x="date", y="value_10000"), alpha=0.2, colour='blue', size=0.25)+
scale_x_date(date_breaks = "1 month", labels = scales::date_format("%Y-%m"))+
labs(
x=NULL, y=NULL,
title="Online consultation instances",
subtitle =  glue::glue("OC instance rate per 10,000 patients")
)+
theme_bw()+
theme(
panel.border = element_blank(),
axis.text.x = element_text(angle = 70, vjust = 1, hjust=1),
)
ggsave(
units = "cm",
height = 10,
width = 15,
limitsize=FALSE,
filename = str_c("plot_overall_ocir_pop.png"),
path = here::here("output", "plots"))
measures_gpc_pop %>% mutate(value_10000 = value*10000) %>%
ggplot()+
geom_line(aes_string(x="date", y="value_10000"), alpha=0.2, colour='blue', size=0.25)+
scale_x_date(date_breaks = "1 month", labels = scales::date_format("%Y-%m"))+
labs(
x=NULL, y=NULL,
title="GP consultation instances",
subtitle =  glue::glue("GP consulation rate per 10,000 patients")
)+
theme_bw()+
theme(
panel.border = element_blank(),
axis.text.x = element_text(angle = 70, vjust = 1, hjust=1),
)
ggsave(
units = "cm",
height = 10,
width = 15,
limitsize=FALSE,
filename = str_c("plot_overall_gpc_pop.png"),
path = here::here("output", "plots"))
quibble <- function(x, q = c(0.25, 0.5, 0.75)) {
## function that takes a vector and returns a tibble of its quantiles
tibble("{{ x }}" := quantile(x, q), "{{ x }}_q" := q)
}
## generate plots for each measure within the data frame
measures_plots <- measures %>%
mutate(
data_quantiles = map(data, ~ (.) %>% group_by(date) %>% summarise(quibble(value, seq(0,1,0.1)))),
plot_by = pmap(lst( group_by, data, measure_label, by_label),
function(group_by, data, measure_label, by_label){
data %>% mutate(value_10000 = value*10000) %>%
ggplot()+
geom_line(aes_string(x="date", y="value_10000", group=group_by), alpha=0.2, colour='blue', size=0.25)+
scale_x_date(date_breaks = "1 month", labels = scales::date_format("%Y-%m"))+
labs(
x=NULL, y=NULL,
title=glue::glue("{measure_label} measurement"),
subtitle =  glue::glue("{by_label}, per 10,000 patients")
)+
theme_bw()+
theme(
panel.border = element_blank(),
axis.line.x = element_line(colour = "black"),
axis.text.x = element_text(angle = 70, vjust = 1, hjust=1),
panel.grid.major.x = element_blank(),
panel.grid.minor.x = element_blank(),
)
}
),
plot_quantiles = pmap(lst( group_by, data_quantiles, measure_label, by_label),
function(group_by, data_quantiles, measure_label, by_label){
data_quantiles %>% mutate(value_10000 = value*10000) %>%
ggplot()+
geom_line(aes(x=date, y=value_10000, group=value_q, linetype=value_q==0.5, size=value_q==0.5), colour='blue')+
scale_linetype_manual(breaks=c(TRUE, FALSE), values=c("solid", "dotted"), guide=FALSE)+
scale_size_manual(breaks=c(TRUE, FALSE), values=c(1, 0.4), guide=FALSE)+
scale_x_date(date_breaks = "1 month", labels = scales::date_format("%Y-%m"))+
labs(
x=NULL, y=NULL,
title=glue::glue("{measure_label} volume per 10,000 patients"),
subtitle = glue::glue("quantiles {by_label}")
)+
theme_bw()+
theme(
panel.border = element_blank(),
axis.line.x = element_line(colour = "black"),
axis.text.x = element_text(angle = 70, vjust = 1, hjust=1),
panel.grid.major.x = element_blank(),
panel.grid.minor.x = element_blank(),
#axis.line.y = element_blank(),
)
}
)
)
## plot the charts (by variable)
measures_plots %>%
transmute(
plot = plot_by,
units = "cm",
height = 10,
width = 15,
limitsize=FALSE,
filename = str_c("plot_each_", id, ".png"),
path = here::here("output", "plots"),
) %>%
pwalk(ggsave)
## plot the charts (by quantile)
measures_plots %>%
transmute(
plot = plot_quantiles,
units = "cm",
height = 10,
width = 15,
limitsize=FALSE,
filename = str_c("plot_quantiles_", id, ".png"),
path = here::here("output", "plots"),
) %>%
pwalk(ggsave)
getwd()
## open log connection to file
sink(here::here("logs", "log-03-createnattrends.txt"))
## library
library(tidyverse)
library(here)
query_dates=seq(as.Date("2019-07-01"),length=18,by="months")
query_dates <- paste0(query_dates)
df_input <- read_csv(
here::here("output",paste0("input_measures_",  query_dates[1], ".csv")))
df_input <- df_input %>% mutate(month=query_dates[1])
for (datenow in tail(query_dates,-1)){
df_input_now <- read_csv(
here::here("output",paste0("input_measures_",  datenow, ".csv")))
df_input_now <- df_input_now %>% mutate(month=datenow)
df_input <- df_input %>% bind_rows(df_input_now)
}
df_input <- as.data.frame(df_input)
rm(df_input_now)
df_summary <- df_input %>%
group_by(month) %>%
summarise_at(vars(starts_with("OC")),~sum(.,na.rm=T))
rm(df_input)
df_summary_long <- df_summary %>% pivot_longer(cols=starts_with("OC"),
names_to="Code",
values_to="Count")
write.csv(df_summary_long,paste0(here::here("output"),"/sc03_tb01_nattrends.csv"))
ggplot(data=df_summary_long,aes(x=as.Date(month),y=Count,fill=Code)) +
geom_bar(stat="identity") +
facet_wrap(~Code,nrow=2,scales="free_y") +
scale_x_date(date_breaks = "2 months",expand=c(0,0))  +
theme(axis.text.x = element_text(angle = -90,vjust = 0))
View(df_summary_long)
View(df_summary)
df_input <- read_csv(
here::here("output",paste0("input_measures_bycode",  query_dates[1], ".csv")))
## open log connection to file
sink(here::here("logs", "log-03-createnattrends.txt"))
## library
library(tidyverse)
library(here)
query_dates=seq(as.Date("2019-07-01"),length=18,by="months")
query_dates <- paste0(query_dates)
df_input <- read_csv(
here::here("output",paste0("input_measures_bycode_",  query_dates[1], ".csv")))
df_input <- df_input %>% mutate(month=query_dates[1])
for (datenow in tail(query_dates,-1)){
df_input_now <- read_csv(
here::here("output",paste0("input_measures_bycode_",  datenow, ".csv")))
df_input_now <- df_input_now %>% mutate(month=datenow)
df_input <- df_input %>% bind_rows(df_input_now)
}
df_input <- as.data.frame(df_input)
rm(df_input_now)
df_summary <- df_input %>%
group_by(month) %>%
summarise_at(vars(starts_with("OC")),~sum(.,na.rm=T))
rm(df_input)
df_summary_long <- df_summary %>% pivot_longer(cols=starts_with("OC"),
names_to="Code",
values_to="Count")
write.csv(df_summary_long,paste0(here::here("output"),"/sc03_tb01_nattrends.csv"))
ggplot(data=df_summary_long,aes(x=as.Date(month),y=Count,fill=Code)) +
geom_bar(stat="identity") +
facet_wrap(~Code,nrow=2,scales="free_y") +
scale_x_date(date_breaks = "2 months",expand=c(0,0))  +
theme(axis.text.x = element_text(angle = -90,vjust = 0))
ggsave(paste0(here::here("output"),"/sc03_fig01_nattrends.png"),width = 40, height = 20, dpi=300,units ="cm")
ggplot(data=df_summary_long %>% mutate(month=as.Date(month)) %>% filter(Code!="GVC_comparator_consult_count"),aes(x=month,y=Count,color=Code)) +
geom_line()+
scale_x_date(date_breaks = "2 months",expand=c(0,0))+
theme(axis.text.x = element_text(angle = -90,vjust = 0))
ggsave(paste0(here::here("output"),"/sc03_fig02_nattrends.png"),width = 40, height = 20, dpi=300,units ="cm")
## close log connection
sink()
## open log connection to file
sink(here::here("logs", "log-03-createnattrends.txt"))
## library
library(tidyverse)
library(here)
library(svglite)
`%!in%` = Negate(`%in%`)
query_dates=seq(as.Date("2019-01-01"),length=24,by="months")
query_dates <- paste0(query_dates)
df_input <- read_csv(
here::here("output",paste0("input_measures_bycode_",  query_dates[1], ".csv")))
query_dates=seq(as.Date("2019-07-01"),length=18,by="months")
query_dates <- paste0(query_dates)
df_input <- read_csv(
here::here("output",paste0("input_measures_bycode_",  query_dates[1], ".csv")))
df_input <- df_input %>% mutate(month=query_dates[1])
for (datenow in tail(query_dates,-1)){
df_input_now <- read_csv(
here::here("output",paste0("input_measures_bycode_",  datenow, ".csv")))
df_input_now <- df_input_now %>% mutate(month=datenow)
df_input <- df_input %>% bind_rows(df_input_now)
}
df_input <- as.data.frame(df_input)
rm(df_input_now)
df_summary <- df_input %>%
group_by(month) %>%
summarise_at(vars(starts_with("OC")),~sum(.,na.rm=T))
df_summary_pop <- df_input %>% group_by(month) %>% summarise(GVC_population=n())
df_summary <- left_join(df_summary,df_summary_pop,id="month")
rm(df_input)
rm(df_summary_pop)
df_summary_long <- df_summary %>% pivot_longer(cols=starts_with("OC"),
names_to="Code",
values_to="Count")
write.csv(df_summary_long,paste0(here::here("output"),"/sc03_tb01_nattrends.csv"))
View(df_summary_long)
## open log connection to file
sink(here::here("logs", "log-03-createnattrends.txt"))
## library
library(tidyverse)
library(here)
library(svglite)
`%!in%` = Negate(`%in%`)
query_dates=seq(as.Date("2019-07-01"),length=18,by="months")
query_dates <- paste0(query_dates)
df_input <- read_csv(
here::here("output",paste0("input_measures_bycode_",  query_dates[1], ".csv")))
df_input <- df_input %>% mutate(month=query_dates[1])
for (datenow in tail(query_dates,-1)){
df_input_now <- read_csv(
here::here("output",paste0("input_measures_bycode_",  datenow, ".csv")))
df_input_now <- df_input_now %>% mutate(month=datenow)
df_input <- df_input %>% bind_rows(df_input_now)
}
df_input <- as.data.frame(df_input)
View(df_input)
df_input <- df_input %>% rename(OC_gp_consult_count=gp_consult_count)
rm(df_input_now)
View(df_input)
df_summary <- df_input %>%
group_by(month) %>%
summarise_at(vars(starts_with("OC")),~sum(.,na.rm=T))
df_summary_pop <- df_input %>% group_by(month) %>% summarise(OC_population=n())
df_summary <- left_join(df_summary,df_summary_pop,id="month")
rm(df_input)
rm(df_summary_pop)
df_summary_long <- df_summary %>% pivot_longer(cols=starts_with("OC"),
names_to="Code",
values_to="Count")
write.csv(df_summary_long,paste0(here::here("output"),"/sc03_tb01_nattrends.csv"))
View(df_summary_long)
df_summary_long$month <- as.Date(df_summary_long$month)
ggplot(data=df_summary_long,aes(x=month,y=Count,fill=Code)) +
geom_bar(stat="identity") +
facet_wrap(~Code,nrow=2,scales="free_y") +
scale_x_date(date_breaks = "2 months",expand=c(0,0))  +
theme(axis.text.x = element_text(angle = -90,vjust = 0))
ggsave(paste0(here::here("output"),"/sc03_fig01_nattrends.svg"),width = 40, height = 20, dpi=300,units ="cm")
ggplot(data=df_summary_long %>% filter(Code%!in% c("OC_comparator_consult_count","OC_population")),aes(x=month,y=Count,color=Code)) +
geom_line()+
scale_x_date(date_breaks = "2 months",expand=c(0,0))+
theme(axis.text.x = element_text(angle = -90,vjust = 0))
ggsave(paste0(here::here("output"),"/sc03_fig02_nattrends.svg"),width = 40, height = 20, dpi=300,units ="cm")
ggplot(data=df_summary_long %>% filter(Code%!in% c("OC_gp_consult_count","OC_population")),aes(x=month,y=Count,color=Code)) +
geom_line()+
scale_x_date(date_breaks = "2 months",expand=c(0,0))+
theme(axis.text.x = element_text(angle = -90,vjust = 0))
ggsave(paste0(here::here("output"),"/sc03_fig02_nattrends.svg"),width = 40, height = 20, dpi=300,units ="cm")
## close log connection
sink()
